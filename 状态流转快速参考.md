# 游戏状态流转快速参考

## 状态列表

| 状态码 | 状态名称 | 说明 | 客户端可见性 |
|--------|----------|------|--------------|
| 0 | Init | 初始状态 | 不可见 |
| 1 | InReview | 审核中 | 不可见 |
| 2 | Approved | 审核通过 | 不可见 |
| 3 | PreRegister | 可预约 | 部分可见（即将上新） |
| 4 | Published | 已上架 | 可见 |
| 5 | Unpublished | 已下架 | 部分可见（历史游戏） |

## 事件列表

| 事件码 | 事件名称 | 说明 |
|--------|----------|------|
| 0 | SubmitForReview | 提交审核 |
| 1 | Approve | 审核通过 |
| 2 | Reject | 审核失败 |
| 3 | PreRegister | 预约发布 |
| 4 | PublishNow | 立即发布 |
| 5 | UpdateInfo | 更新游戏信息 |
| 6 | CancelPreRegister | 取消预约发布 |
| 7 | UnpublishNow | 立即下架 |
| 8 | UpdateVersion | 更新游戏版本 |
| 9 | AutoPublish | 自动发布（系统触发） |

## 状态转换规则

| 当前状态 | 可用事件 | 目标状态 | API接口 |
|---------|---------|---------|---------|
| Init | SubmitForReview | InReview | POST /games/{id}/submit-review |
| InReview | Approve | Approved | POST /games/{id}/approve |
| InReview | Reject | Init | POST /games/{id}/reject |
| Approved | PreRegister | PreRegister | POST /games/{id}/pre-register |
| Approved | PublishNow | Published | POST /games/{id}/publish-now |
| Approved | UpdateInfo | Init | POST /games/{id}/update-info |
| PreRegister | AutoPublish | Published | (定时任务自动执行) |
| PreRegister | CancelPreRegister | Approved | POST /games/{id}/cancel-pre-register |
| PreRegister | UpdateInfo | Init | POST /games/{id}/update-info |
| Published | UnpublishNow | Unpublished | POST /games/{id}/unpublish |
| Published | UpdateVersion | Init | POST /games/{id}/update-version |
| Unpublished | UpdateInfo | Init | POST /games/{id}/update-info |

## 常用API接口

### 1. 获取可用事件
```http
GET /games/{id}/available-events
```

返回示例：
```json
{
    "events": [
        {
            "event": 0,
            "event_name": "提交审核",
            "next_status": 1,
            "next_status_name": "审核中"
        }
    ]
}
```

### 2. 提交审核
```http
POST /games/{id}/submit-review
```

### 3. 审核通过
```http
POST /games/{id}/approve
```

### 4. 审核拒绝
```http
POST /games/{id}/reject
```

### 5. 立即发布
```http
POST /games/{id}/publish-now
```

### 6. 预约发布
```http
POST /games/{id}/pre-register
Content-Type: application/json

{
    "publish_time": "2025-10-20 10:00:00"
}
```

### 7. 取消预约
```http
POST /games/{id}/cancel-pre-register
```

### 8. 下架游戏
```http
POST /games/{id}/unpublish
Content-Type: application/json

{
    "unpublish_reason": "违规内容"
}
```

### 9. 更新游戏信息（回到初始状态）
```http
POST /games/{id}/update-info
```

### 10. 更新游戏版本（回到初始状态）
```http
POST /games/{id}/update-version
```

## 典型流程

### 流程1：正常发布流程
```
Init → (提交审核) → InReview → (审核通过) → Approved → (立即发布) → Published
```

### 流程2：预约发布流程
```
Init → (提交审核) → InReview → (审核通过) → Approved 
     → (预约发布) → PreRegister → (自动发布) → Published
```

### 流程3：审核失败重新提交
```
Init → (提交审核) → InReview → (审核失败) → Init → (提交审核) → ...
```

### 流程4：取消预约改为立即发布
```
Approved → (预约发布) → PreRegister → (取消预约) → Approved → (立即发布) → Published
```

### 流程5：已发布游戏更新版本
```
Published → (更新版本) → Init → (提交审核) → InReview → ...
```

### 流程6：已下架游戏重新上架
```
Published → (下架) → Unpublished → (重新编辑) → Init → (提交审核) → ...
```

## 业务规则

### 提交审核前置条件
- 游戏名称不为空
- 开发商不为空
- 发行商不为空
- 至少上传一个媒体文件

### 预约发布注意事项
- 发布时间必须大于当前时间
- 发布时间到达后，系统会自动发布游戏
- 发布后会自动通知所有预约用户

### 立即发布注意事项
- 发布后会自动通知所有预约用户
- 客户端立即可见

### 下架游戏注意事项
- 可以提供下架原因
- 下架后客户端只在特定接口可见

## 定时任务

系统需要定期执行以下定时任务：

```go
// 每分钟执行一次，检查预约时间到期的游戏
service.Game().BatchUpdateGameStatus(ctx)
```

这个任务会：
1. 查找所有状态为 PreRegister 且发布时间已到的游戏
2. 自动触发 AutoPublish 事件
3. 将游戏状态转换为 Published
4. 通知所有预约用户

## 代码示例

### Service层调用
```go
// 提交审核
err := service.Game().SubmitForReview(ctx, gameID)

// 获取可用事件
events, err := service.Game().GetAvailableEvents(ctx, gameID)

// 直接触发事件
err := service.Game().HandleGameEvent(ctx, gameID, model.SubmitForReview)
```

### Logic层调用
```go
game := logics.Game()

// 提交审核
err := game.SubmitForReview(ctx, gameID)

// 审核通过
err := game.Approve(ctx, gameID)

// 立即发布
err := game.PublishGameImmediately(ctx, gameID)

// 预约发布
publishTime := gtime.New("2025-10-20 10:00:00")
err := game.PreRegisterGame(ctx, gameID, publishTime)
```

## 错误处理

所有状态转换方法都会返回错误，常见错误包括：

- `游戏不存在`
- `当前状态[X]不支持事件[Y]`
- `游戏基本信息不完整，无法提交审核`
- `请先上传游戏媒体文件`
- `发布时间不能小于当前时间`

建议在调用时进行适当的错误处理和用户提示。

